# ComfyUI Matting Service - 架构文档 V2.0

## 🎯 设计理念

本项目采用 **Claude Skills 架构模式**，将图像处理功能抽象为独立的"技能"(Skills)，实现了：

1. **前后端解耦** - 前端通过统一的 Skill API 调用后端功能
2. **技能模块化** - 每个 Skill 独立定义、独立实现、独立测试
3. **易于扩展** - 添加新功能只需创建新 Skill，无需修改核心代码
4. **统一管理** - 所有 Skills 定义集中管理，便于维护

## 📐 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户浏览器                                │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              Vue 3 前端应用                               │  │
│  │  src/main/resources/static/index.html                    │  │
│  │                                                           │  │
│  │  - 文件上传                                               │  │
│  │  - Skill 选择                                             │  │
│  │  - 参数调整                                               │  │
│  │  - 结果展示                                               │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────────┘
                         │ HTTP POST /api/skill/matting
                         │ FormData: {image, threshold, ...}
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Spring Boot 应用层                             │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │            Controller 层                                  │  │
│  │  src/main/java/.../controller/                           │  │
│  │                                                           │  │
│  │  ┌─────────────────────────────────────────────────┐     │  │
│  │  │  SkillController                                │     │  │
│  │  │  - POST /api/skill/matting                      │     │  │
│  │  │  - GET  /api/skill/list                         │     │  │
│  │  │  - GET  /api/skill/{name}/info                  │     │  │
│  │  └─────────────────────────────────────────────────┘     │  │
│  │           │                                               │  │
│  │           │ 调用 executeMattingSkill()                    │  │
│  │           ▼                                               │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │            Service 层                                     │  │
│  │  src/main/java/.../service/                              │  │
│  │                                                           │  │
│  │  ┌─────────────────────────────────────────────────┐     │  │
│  │  │  SkillExecutor (技能执行器)                     │     │  │
│  │  │  ┌───────────────────────────────────────┐      │     │  │
│  │  │  │ 1. 验证 Skill 定义文件存在           │      │     │  │
│  │  │  │    .claude/skills/matting.md         │      │     │  │
│  │  │  ├───────────────────────────────────────┤      │     │  │
│  │  │  │ 2. 验证输入参数                      │      │     │  │
│  │  │  │    - threshold: 0.0-1.0              │      │     │  │
│  │  │  │    - alphaMatting: boolean           │      │     │  │
│  │  │  │    - 其他参数范围检查                │      │     │  │
│  │  │  ├───────────────────────────────────────┤      │     │  │
│  │  │  │ 3. 调用 ComfyUIService               │      │     │  │
│  │  │  ├───────────────────────────────────────┤      │     │  │
│  │  │  │ 4. 记录执行日志和时间                │      │     │  │
│  │  │  └───────────────────────────────────────┘      │     │  │
│  │  └─────────────────────────────────────────────────┘     │  │
│  │           │                                               │  │
│  │           │ 调用 runMatting()                             │  │
│  │           ▼                                               │  │
│  │  ┌─────────────────────────────────────────────────┐     │  │
│  │  │  ComfyUIService (ComfyUI API 封装)              │     │  │
│  │  │  ┌───────────────────────────────────────┐      │     │  │
│  │  │  │ 1. 上传图片到 ComfyUI                │      │     │  │
│  │  │  │    POST /upload/image                │      │     │  │
│  │  │  ├───────────────────────────────────────┤      │     │  │
│  │  │  │ 2. 加载工作流 JSON                   │      │     │  │
│  │  │  │    workflows/sam_matting.json        │      │     │  │
│  │  │  ├───────────────────────────────────────┤      │     │  │
│  │  │  │ 3. 更新工作流参数                    │      │     │  │
│  │  │  │    - 设置输入图片                    │      │     │  │
│  │  │  │    - 设置 threshold                  │      │     │  │
│  │  │  │    - 设置 alpha matting 参数         │      │     │  │
│  │  │  ├───────────────────────────────────────┤      │     │  │
│  │  │  │ 4. 执行工作流                        │      │     │  │
│  │  │  │    POST /prompt                      │      │     │  │
│  │  │  ├───────────────────────────────────────┤      │     │  │
│  │  │  │ 5. 等待任务完成                      │      │     │  │
│  │  │  │    WebSocket 监听或轮询              │      │     │  │
│  │  │  ├───────────────────────────────────────┤      │     │  │
│  │  │  │ 6. 下载结果图片                      │      │     │  │
│  │  │  │    GET /view?filename=...            │      │     │  │
│  │  │  └───────────────────────────────────────┘      │     │  │
│  │  └─────────────────────────────────────────────────┘     │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────────┘
                         │ HTTP API 调用
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ComfyUI 服务                                  │
│                                                                 │
│  - 图像处理工作流引擎                                            │
│  - SAM (Segment Anything Model)                                │
│  - Alpha Matting 算法                                           │
│  - 自定义节点支持                                               │
│                                                                 │
│  监听端口: http://127.0.0.1:8188                                │
└─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                   Claude Skills 定义层                           │
│                   .claude/skills/                                │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  matting.md (抠图技能定义)                                │  │
│  │  - 功能描述                                               │  │
│  │  - 输入参数规范                                           │  │
│  │  - 输出格式规范                                           │  │
│  │  - 错误处理说明                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  enhance.md (未来扩展)                                    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  style_transfer.md (未来扩展)                             │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 数据流详解

### 请求流程

```
1. 用户操作
   ↓
   用户在 Vue 前端上传图片并调整参数
   ↓
2. 前端请求
   ↓
   POST /api/skill/matting
   FormData: {
     image: File,
     threshold: 0.3,
     alphaMatting: true,
     ...
   }
   ↓
3. SkillController 接收
   ↓
   解析请求参数，构建 MattingRequest 对象
   ↓
4. SkillExecutor 执行
   ↓
   a. 验证 .claude/skills/matting.md 存在
   b. 验证参数范围 (threshold: 0-1, 前景阈值: 200-255, 等)
   c. 调用 ComfyUIService.runMatting()
   ↓
5. ComfyUIService 处理
   ↓
   a. 上传图片到 ComfyUI → 获得 uploaded_name
   b. 加载工作流 JSON from resources/workflows/sam_matting.json
   c. 更新工作流参数:
      - 节点 10: 设置 image = uploaded_name
      - 节点 15: 设置 threshold = request.threshold
      - 节点 23: 设置 alpha matting 参数
   d. 提交工作流到 ComfyUI → 获得 prompt_id
   e. 等待执行完成 (轮询 /history/{prompt_id})
   f. 下载结果图片到 output/ 目录
   ↓
6. 返回结果
   ↓
   MattingResult {
     success: true,
     outputFilename: "matting_12345.png",
     outputUrl: "/output/matting_12345.png",
     promptId: "abc-123",
     executionTime: 5230
   }
   ↓
7. 前端展示
   ↓
   Vue 显示结果图片，提供下载按钮
```

### 错误处理流程

```
任何环节出错
   ↓
SkillExecutor 捕获异常
   ↓
记录详细日志
   ↓
返回 MattingResult {
  success: false,
  errorMessage: "具体错误信息"
}
   ↓
前端显示错误提示
```

## 📦 核心组件说明

### 1. SkillController

**职责：**
- 处理所有 `/api/skill/*` 路径的 HTTP 请求
- 解析请求参数
- 调用对应的 SkillExecutor 方法
- 返回统一格式的 ApiResponse

**关键方法：**
- `executeMattingSkill()` - 执行抠图技能
- `listSkills()` - 列出所有可用技能
- `getSkillInfo()` - 获取技能详细信息

### 2. SkillExecutor

**职责：**
- 验证 Skill 定义文件存在 (`.claude/skills/{name}.md`)
- 验证输入参数的合法性
- 调用底层 ComfyUIService 执行实际任务
- 记录执行日志和性能指标

**关键方法：**
- `executeMattingSkill()` - 执行抠图
- `validateSkillExists()` - 验证 Skill 定义
- `validateMattingParameters()` - 验证参数
- `isSkillAvailable()` - 检查 Skill 状态
- `getSkillDefinition()` - 读取 Skill 定义

**设计模式：**
- **策略模式** - 每个 Skill 是一个独立的策略
- **模板方法模式** - 统一的执行流程框架

### 3. ComfyUIService

**职责：**
- 封装所有 ComfyUI API 调用
- 管理工作流的加载和执行
- 处理图片上传和下载
- WebSocket 或轮询方式等待任务完成

**关键方法：**
- `runMatting()` - 完整的抠图流程
- `uploadImage()` - 上传图片
- `loadWorkflowFromResource()` - 加载工作流
- `updateWorkflowParams()` - 更新参数
- `executeWorkflow()` - 执行工作流
- `downloadResult()` - 下载结果

### 4. Vue 前端

**技术栈：**
- Vue 3 (CDN 引入)
- Axios (HTTP 客户端)
- 原生 CSS (渐变色设计)

**核心功能：**
- 响应式 UI
- 拖拽上传
- 实时参数调整
- 进度显示
- 结果预览和下载

## 🎯 Claude Skills 设计原则

### 1. 单一职责原则
每个 Skill 只做一件事情，例如：
- `matting.md` - 只负责抠图
- `enhance.md` - 只负责图像增强
- `style_transfer.md` - 只负责风格转换

### 2. 开闭原则
- 对扩展开放：添加新 Skill 无需修改现有代码
- 对修改封闭：核心框架保持稳定

### 3. 接口隔离原则
每个 Skill 定义明确的输入输出接口：
- 输入参数类型和范围
- 输出数据结构
- 错误码和错误信息

### 4. 依赖倒置原则
- SkillExecutor 依赖 Skill 定义（抽象），而不是具体实现
- 便于测试和 Mock

## 🔐 安全考虑

### 1. 文件上传安全
- 限制文件类型：只允许图片格式
- 限制文件大小：默认 50MB
- 文件名随机化：防止路径遍历攻击

### 2. 参数验证
- SkillExecutor 严格验证所有参数范围
- 防止注入攻击

### 3. 资源隔离
- 每个任务独立的输出目录
- 临时文件定期清理

## 📈 性能优化

### 1. 异步处理
- ComfyUI 任务异步执行
- 前端轮询或 WebSocket 获取进度

### 2. 缓存策略
- 工作流 JSON 缓存
- 静态资源浏览器缓存

### 3. 资源管理
- HTTP 连接池
- 线程池管理
- 文件流及时关闭

## 🚀 未来扩展

### 1. 批量处理
- 支持多图片同时处理
- 队列管理

### 2. Skill 链
- 组合多个 Skills
- 创建复杂的处理流程

### 3. 用户系统
- 用户认证和授权
- 使用配额管理

### 4. 监控和日志
- Prometheus 指标收集
- ELK 日志分析

## 📝 总结

这个架构的核心优势：

1. **模块化** - Skills 作为独立模块，易于开发和测试
2. **可扩展** - 添加新功能非常简单
3. **可维护** - 清晰的分层和职责划分
4. **用户友好** - Vue 提供优秀的用户体验
5. **技术先进** - JDK 21, Vue 3, Spring Boot 3.2

---

**架构设计原则：简单、模块化、可扩展** 🎯
