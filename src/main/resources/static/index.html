<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI æ™ºèƒ½æŠ å›¾ - Claude Skills</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        #app {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .header .tech-stack {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            margin-top: 15px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .status-badge.online {
            background: rgba(76, 175, 80, 0.3);
            color: white;
        }

        .status-badge.offline {
            background: rgba(244, 67, 54, 0.3);
            color: white;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .skill-selector {
            margin-bottom: 30px;
        }

        .skill-selector h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .skill-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .skill-btn {
            padding: 15px 30px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .skill-btn:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .skill-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e8e8ff;
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            margin-top: 20px;
        }

        /* è’™ç‰ˆç»˜åˆ¶åŒºåŸŸæ ·å¼ */
        .mask-drawing-section {
            margin-top: 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            background: #f9f9ff;
        }

        .mask-drawing-section h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .mask-canvas-container {
            position: relative;
            display: inline-block;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
        }

        .mask-canvas {
            display: block;
            cursor: crosshair;
            max-width: 100%;
        }

        .mask-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .mask-tool-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .mask-tool-btn:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .mask-tool-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .brush-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brush-size-control label {
            font-weight: 500;
            color: #555;
        }

        .brush-size-control input[type="range"] {
            width: 150px;
        }

        .mask-preview {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .mask-preview h5 {
            margin-bottom: 10px;
            color: #555;
            font-size: 0.9rem;
        }

        .mask-preview canvas {
            max-width: 100%;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        .params-section {
            margin-bottom: 30px;
        }

        .params-section h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .param-group {
            margin-bottom: 20px;
        }

        .param-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .param-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
        }

        .param-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .param-value {
            display: inline-block;
            margin-left: 10px;
            color: #667eea;
            font-weight: bold;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .progress {
            margin-top: 20px;
            padding: 20px;
            background: #f0f0ff;
            border-radius: 10px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-section {
            margin-top: 30px;
        }

        .result-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .result-info {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }

        .result-info p {
            margin-bottom: 10px;
            color: #555;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>ğŸ¨ ComfyUI æ™ºèƒ½æŠ å›¾æœåŠ¡</h1>
            <span class="status-badge" :class="serverStatus ? 'online' : 'offline'">
                {{ serverStatus ? 'ğŸŸ¢ æœåŠ¡åœ¨çº¿' : 'ğŸ”´ æœåŠ¡ç¦»çº¿' }}
            </span>
        </div>

        <div class="card">
            <!-- Skill é€‰æ‹©å™¨ -->
            <div class="skill-selector">
                <h3>é€‰æ‹©åŠŸèƒ½</h3>
                <div class="skill-buttons">
                    <button
                        class="skill-btn"
                        :class="{ active: selectedSkill === 'matting' }"
                        @click="selectSkill('matting')">
                        ğŸ¯ æ™ºèƒ½æŠ å›¾
                    </button>
                    <a href="matting-keyword.html" style="text-decoration: none; color: inherit;">
                        <button class="skill-btn">
                            ğŸ” å…³é”®å­—æŠ å›¾
                        </button>
                    </a>
                    <!-- æœªæ¥å¯ä»¥æ·»åŠ æ›´å¤š skills -->
                    <button class="skill-btn" disabled style="opacity: 0.5;">
                        âœ¨ å›¾åƒå¢å¼º (å³å°†æ¨å‡º)
                    </button>
                    <button class="skill-btn" disabled style="opacity: 0.5;">
                        ğŸ¨ é£æ ¼è½¬æ¢ (å³å°†æ¨å‡º)
                    </button>
                </div>
            </div>

            <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
            <div
                class="upload-area"
                :class="{ dragover: isDragging }"
                @click="triggerFileInput"
                @dragover.prevent="isDragging = true"
                @dragleave.prevent="isDragging = false"
                @drop.prevent="handleFileDrop">
                <div v-if="!previewUrl" class="upload-icon">ğŸ“¤</div>
                <div v-if="!previewUrl">
                    <p style="font-size: 1.2rem; color: #666; margin-bottom: 10px;">
                        ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡
                    </p>
                    <p style="font-size: 0.9rem; color: #999;">
                        æ”¯æŒ JPG, PNG æ ¼å¼
                    </p>
                </div>
                <img v-if="previewUrl" :src="previewUrl" class="preview-image" alt="é¢„è§ˆ">
                <input
                    type="file"
                    ref="fileInput"
                    @change="handleFileSelect"
                    accept="image/*"
                    style="display: none;">
            </div>

            <!-- è’™ç‰ˆç»˜åˆ¶åŒºåŸŸ -->
            <div v-if="selectedFile && previewUrl" class="mask-drawing-section">
                <h4>ğŸ¨ è’™ç‰ˆç»˜åˆ¶åŒºåŸŸ</h4>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">
                    é»˜è®¤æ•´å¼ å›¾éƒ½ä¼šè¢«æŠ å›¾ã€‚ä½¿ç”¨æ©¡çš®æ“¦æ ‡è®°ä¸éœ€è¦æŠ å›¾çš„åŒºåŸŸï¼Œæˆ–ç‚¹å‡»"æ¸…é™¤è’™ç‰ˆ"åç”¨ç”»ç¬”ç²¾ç¡®æ ‡è®°è¦æŠ å›¾çš„éƒ¨åˆ†
                </p>

                <!-- ç»˜åˆ¶å·¥å…·æ  -->
                <div class="mask-toolbar">
                    <button
                        class="mask-tool-btn"
                        :class="{ active: maskTool === 'brush' }"
                        @click="selectMaskTool('brush')">
                        ğŸ–Œï¸ ç”»ç¬”
                    </button>
                    <button
                        class="mask-tool-btn"
                        :class="{ active: maskTool === 'eraser' }"
                        @click="selectMaskTool('eraser')">
                        ğŸ§¹ æ©¡çš®æ“¦
                    </button>
                    <button
                        class="mask-tool-btn"
                        @click="clearMask">
                        ğŸ—‘ï¸ æ¸…é™¤è’™ç‰ˆ
                    </button>

                    <div class="brush-size-control">
                        <label>ç”»ç¬”å¤§å°:</label>
                        <input
                            type="range"
                            v-model.number="brushSize"
                            min="5"
                            max="100"
                            step="5">
                        <span class="param-value">{{ brushSize }}px</span>
                    </div>
                </div>

                <!-- Canvas ç”»å¸ƒ -->
                <div class="mask-canvas-container">
                    <canvas
                        ref="maskCanvas"
                        class="mask-canvas"
                        @mousedown="startDrawing"
                        @mousemove="draw"
                        @mouseup="stopDrawing"
                        @mouseleave="stopDrawing"
                        @touchstart="startDrawing"
                        @touchmove="draw"
                        @touchend="stopDrawing">
                    </canvas>
                </div>

                <!-- è’™ç‰ˆé¢„è§ˆ -->
                <div class="mask-preview">
                    <h5>è’™ç‰ˆé¢„è§ˆï¼ˆç™½è‰² = é€‰ä¸­åŒºåŸŸï¼‰</h5>
                    <canvas ref="maskPreviewCanvas" width="300" height="200"></canvas>
                </div>
            </div>

            <!-- å‚æ•°è°ƒæ•´ -->
            <div v-if="selectedSkill === 'matting' && selectedFile" class="params-section">
                <h3>âš™ï¸ å‚æ•°è°ƒæ•´</h3>

                <div class="param-group">
                    <label>
                        SAM æ£€æµ‹é˜ˆå€¼
                        <span class="param-value">{{ params.threshold }}</span>
                    </label>
                    <input
                        type="range"
                        v-model.number="params.threshold"
                        min="0"
                        max="1"
                        step="0.1">
                    <p style="font-size: 0.85rem; color: #999; margin-top: 5px;">
                        è¾ƒä½çš„å€¼ä¼šæ£€æµ‹æ›´å¤šå¯¹è±¡ï¼Œè¾ƒé«˜çš„å€¼æ›´ç²¾ç¡®
                    </p>
                </div>

                <div class="param-group">
                    <label>
                        <input type="checkbox" v-model="params.alphaMatting">
                        å¯ç”¨è¾¹ç¼˜ä¼˜åŒ– (Alpha Matting)
                    </label>
                </div>

                <div v-if="params.alphaMatting" style="margin-left: 30px;">
                    <div class="param-group">
                        <label>
                            å‰æ™¯é˜ˆå€¼
                            <span class="param-value">{{ params.alphaMattingForegroundThreshold }}</span>
                        </label>
                        <input
                            type="range"
                            v-model.number="params.alphaMattingForegroundThreshold"
                            min="200"
                            max="255"
                            step="5">
                    </div>

                    <div class="param-group">
                        <label>
                            èƒŒæ™¯é˜ˆå€¼
                            <span class="param-value">{{ params.alphaMattingBackgroundThreshold }}</span>
                        </label>
                        <input
                            type="range"
                            v-model.number="params.alphaMattingBackgroundThreshold"
                            min="0"
                            max="50"
                            step="5">
                    </div>

                    <div class="param-group">
                        <label>
                            è¾¹ç¼˜è…èš€å¤§å°
                            <span class="param-value">{{ params.alphaMattingErodeSize }}</span>
                        </label>
                        <input
                            type="range"
                            v-model.number="params.alphaMattingErodeSize"
                            min="0"
                            max="20"
                            step="1">
                    </div>
                </div>
            </div>

            <!-- æ‰§è¡ŒæŒ‰é’® -->
            <div style="text-align: center;">
                <button
                    class="btn btn-primary"
                    @click="executeSkill"
                    :disabled="!selectedFile || processing">
                    {{ processing ? 'å¤„ç†ä¸­...' : 'ğŸš€ å¼€å§‹æ‰§è¡Œ' }}
                </button>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div v-if="processing" class="progress">
                <div class="spinner"></div>
                <p>{{ progressMessage }}</p>
            </div>

            <!-- é”™è¯¯æ˜¾ç¤º -->
            <div v-if="errorMessage" class="error">
                âŒ {{ errorMessage }}
            </div>

            <!-- ç»“æœæ˜¾ç¤º -->
            <div v-if="result" class="result-section">
                <h3>âœ… å¤„ç†ç»“æœ</h3>
                <img :src="result.outputUrl" class="result-image" alt="å¤„ç†ç»“æœ">
                <div class="result-info">
                    <p><strong>è¾“å‡ºæ–‡ä»¶:</strong> {{ result.outputFilename }}</p>
                    <p><strong>æ‰§è¡Œæ—¶é—´:</strong> {{ result.executionTime }}ms</p>
                    <p><strong>Prompt ID:</strong> {{ result.promptId }}</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <a :href="result.outputUrl" download class="btn btn-primary">
                        ğŸ’¾ ä¸‹è½½ç»“æœ
                    </a>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Powered by Vue 3 + Spring Boot + ComfyUI</p>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    serverStatus: false,
                    selectedSkill: 'matting',
                    selectedFile: null,
                    previewUrl: null,
                    isDragging: false,
                    processing: false,
                    progressMessage: '',
                    errorMessage: null,
                    result: null,
                    params: {
                        threshold: 0.3,
                        alphaMatting: true,
                        alphaMattingForegroundThreshold: 240,
                        alphaMattingBackgroundThreshold: 10,
                        alphaMattingErodeSize: 10
                    },
                    // è’™ç‰ˆç»˜åˆ¶ç›¸å…³
                    maskTool: 'brush',
                    brushSize: 30,
                    isDrawing: false,
                    maskCanvas: null,
                    maskCtx: null,
                    maskData: null, // çº¯è’™ç‰ˆæ•°æ® (é»‘ç™½)
                    originalImage: null
                };
            },
            mounted() {
                this.checkServerStatus();
            },
            methods: {
                async checkServerStatus() {
                    try {
                        const response = await axios.get('/api/matting/status');
                        this.serverStatus = response.data.code === 200;
                    } catch (error) {
                        this.serverStatus = false;
                        console.error('æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€å¤±è´¥:', error);
                    }
                },
                selectSkill(skill) {
                    this.selectedSkill = skill;
                    this.result = null;
                    this.errorMessage = null;
                },
                triggerFileInput() {
                    this.$refs.fileInput.click();
                },
                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.loadFile(file);
                    }
                },
                handleFileDrop(event) {
                    this.isDragging = false;
                    const file = event.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.loadFile(file);
                    }
                },
                loadFile(file) {
                    this.selectedFile = file;
                    this.previewUrl = URL.createObjectURL(file);
                    this.result = null;
                    this.errorMessage = null;

                    // åŠ è½½å›¾åƒåˆ° Canvas
                    const img = new Image();
                    img.onload = () => {
                        this.originalImage = img;
                        this.$nextTick(() => {
                            this.initMaskCanvas(img);
                        });
                    };
                    img.src = this.previewUrl;
                },
                // åˆå§‹åŒ–è’™ç‰ˆ Canvas
                initMaskCanvas(img) {
                    const canvas = this.$refs.maskCanvas;
                    if (!canvas) return;

                    // è®¾ç½® Canvas å°ºå¯¸ä¸å›¾åƒä¸€è‡´
                    const maxWidth = 800;
                    let width = img.width;
                    let height = img.height;

                    // ç¼©æ”¾å›¾åƒä»¥é€‚åº”æ˜¾ç¤º
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    this.maskCtx = ctx;

                    // åˆ›å»ºçº¯ç™½è‰²è’™ç‰ˆæ•°æ®ï¼ˆåˆå§‹å…¨ç™½ = å¤„ç†æ•´å¼ å›¾ï¼‰
                    this.maskData = ctx.createImageData(width, height);
                    for (let i = 0; i < this.maskData.data.length; i += 4) {
                        this.maskData.data[i] = 255;     // R = ç™½è‰²
                        this.maskData.data[i + 1] = 255; // G = ç™½è‰²
                        this.maskData.data[i + 2] = 255; // B = ç™½è‰²
                        this.maskData.data[i + 3] = 255; // A
                    }

                    // ç»˜åˆ¶æ˜¾ç¤ºæ•ˆæœï¼šåŸå›¾ + åŠé€æ˜é»‘è‰²é®ç½©
                    this.redrawCanvas();
                    this.updateMaskPreview();
                },
                // é‡ç»˜ Canvas æ˜¾ç¤ºæ•ˆæœ
                redrawCanvas() {
                    const canvas = this.$refs.maskCanvas;
                    const ctx = this.maskCtx;
                    if (!canvas || !ctx || !this.originalImage) return;

                    // å…ˆç»˜åˆ¶åŸå›¾
                    ctx.drawImage(this.originalImage, 0, 0, canvas.width, canvas.height);

                    // æ ¹æ®è’™ç‰ˆæ•°æ®ç»˜åˆ¶åŠé€æ˜é®ç½©
                    const imageData = ctx.createImageData(canvas.width, canvas.height);
                    for (let i = 0; i < this.maskData.data.length; i += 4) {
                        const maskValue = this.maskData.data[i]; // è’™ç‰ˆå€¼ (0=é»‘è‰²/ä¸å¤„ç†, 255=ç™½è‰²/å¤„ç†)
                        if (maskValue < 128) {
                            // é»‘è‰²è’™ç‰ˆåŒºåŸŸ -> æ˜¾ç¤ºåŠé€æ˜é»‘è‰²é®ç½©
                            imageData.data[i] = 0;
                            imageData.data[i + 1] = 0;
                            imageData.data[i + 2] = 0;
                            imageData.data[i + 3] = 128; // åŠé€æ˜
                        } else {
                            // ç™½è‰²è’™ç‰ˆåŒºåŸŸ -> é€æ˜ï¼ˆæ˜¾ç¤ºåŸå›¾ï¼‰
                            imageData.data[i] = 0;
                            imageData.data[i + 1] = 0;
                            imageData.data[i + 2] = 0;
                            imageData.data[i + 3] = 0;
                        }
                    }

                    // å°†é®ç½©å±‚å åŠ åˆ°åŸå›¾ä¸Š
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.putImageData(imageData, 0, 0);
                    ctx.drawImage(tempCanvas, 0, 0);
                },
                // é€‰æ‹©ç»˜åˆ¶å·¥å…·
                selectMaskTool(tool) {
                    this.maskTool = tool;
                },
                // å¼€å§‹ç»˜åˆ¶
                startDrawing(event) {
                    this.isDrawing = true;
                    this.draw(event);
                },
                // ç»˜åˆ¶
                draw(event) {
                    if (!this.isDrawing || !this.maskData) return;

                    event.preventDefault();
                    const canvas = this.$refs.maskCanvas;
                    const rect = canvas.getBoundingClientRect();

                    let clientX, clientY;
                    if (event.type.startsWith('touch')) {
                        clientX = event.touches[0].clientX;
                        clientY = event.touches[0].clientY;
                    } else {
                        clientX = event.clientX;
                        clientY = event.clientY;
                    }

                    const x = (clientX - rect.left) * (canvas.width / rect.width);
                    const y = (clientY - rect.top) * (canvas.height / rect.height);

                    // ç›´æ¥ä¿®æ”¹è’™ç‰ˆæ•°æ®
                    const radius = this.brushSize / 2;
                    const maskValue = this.maskTool === 'brush' ? 255 : 0; // ç”»ç¬”=ç™½è‰²(255), æ©¡çš®æ“¦=é»‘è‰²(0)

                    for (let dy = -radius; dy <= radius; dy++) {
                        for (let dx = -radius; dx <= radius; dx++) {
                            if (dx * dx + dy * dy <= radius * radius) {
                                const px = Math.floor(x + dx);
                                const py = Math.floor(y + dy);
                                if (px >= 0 && px < canvas.width && py >= 0 && py < canvas.height) {
                                    const idx = (py * canvas.width + px) * 4;
                                    this.maskData.data[idx] = maskValue;     // R
                                    this.maskData.data[idx + 1] = maskValue; // G
                                    this.maskData.data[idx + 2] = maskValue; // B
                                    // Alpha ä¿æŒ 255
                                }
                            }
                        }
                    }

                    this.redrawCanvas();
                    this.updateMaskPreview();
                },
                // åœæ­¢ç»˜åˆ¶
                stopDrawing() {
                    this.isDrawing = false;
                },
                // æ¸…é™¤è’™ç‰ˆ
                clearMask() {
                    if (!this.originalImage) return;
                    this.initMaskCanvas(this.originalImage);
                },
                // æ›´æ–°è’™ç‰ˆé¢„è§ˆ
                updateMaskPreview() {
                    const canvas = this.$refs.maskCanvas;
                    const previewCanvas = this.$refs.maskPreviewCanvas;
                    if (!canvas || !previewCanvas || !this.maskData) return;

                    const ctx = previewCanvas.getContext('2d');
                    const width = previewCanvas.width;
                    const height = previewCanvas.height;

                    // å°†è’™ç‰ˆæ•°æ®ç»˜åˆ¶åˆ°ä¸´æ—¶ canvas
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.putImageData(this.maskData, 0, 0);

                    // ç¼©æ”¾ç»˜åˆ¶åˆ°é¢„è§ˆ
                    ctx.fillStyle = 'black';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(tempCanvas, 0, 0, width, height);
                },
                // ç”Ÿæˆå¸¦è’™ç‰ˆçš„å›¾åƒï¼ˆalpha é€šé“ï¼‰
                async generateMaskedImage() {
                    return new Promise((resolve) => {
                        const canvas = this.$refs.maskCanvas;
                        if (!canvas || !this.maskData) {
                            resolve(null);
                            return;
                        }

                        const resultCanvas = document.createElement('canvas');
                        resultCanvas.width = this.originalImage.width;
                        resultCanvas.height = this.originalImage.height;
                        const ctx = resultCanvas.getContext('2d');

                        // ç»˜åˆ¶åŸå›¾
                        ctx.drawImage(this.originalImage, 0, 0);

                        // å°†è’™ç‰ˆæ•°æ®ç¼©æ”¾åˆ°åŸå§‹å°ºå¯¸
                        const maskCanvas = document.createElement('canvas');
                        maskCanvas.width = canvas.width;
                        maskCanvas.height = canvas.height;
                        const maskCtx = maskCanvas.getContext('2d');
                        maskCtx.putImageData(this.maskData, 0, 0);

                        const scaledMask = document.createElement('canvas');
                        scaledMask.width = this.originalImage.width;
                        scaledMask.height = this.originalImage.height;
                        const scaledCtx = scaledMask.getContext('2d');
                        scaledCtx.drawImage(maskCanvas, 0, 0, scaledMask.width, scaledMask.height);

                        // å°†è’™ç‰ˆä½œä¸º alpha é€šé“åˆå¹¶åˆ°åŸå›¾
                        const resultData = ctx.getImageData(0, 0, resultCanvas.width, resultCanvas.height);
                        const scaledMaskData = scaledCtx.getImageData(0, 0, scaledMask.width, scaledMask.height);

                        for (let i = 0; i < resultData.data.length; i += 4) {
                            // ä½¿ç”¨è’™ç‰ˆçš„ R é€šé“å€¼ä½œä¸º alpha å€¼
                            // ç™½è‰²(255) -> alpha = 255 (ä¸é€æ˜)
                            // é»‘è‰²(0) -> alpha = 0 (é€æ˜)
                            const maskValue = scaledMaskData.data[i];
                            resultData.data[i + 3] = maskValue;
                        }

                        ctx.putImageData(resultData, 0, 0);

                        // è½¬æ¢ä¸º PNG Blob
                        resultCanvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/png');
                    });
                },
                async executeSkill() {
                    if (!this.selectedFile) {
                        this.errorMessage = 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡';
                        return;
                    }

                    this.processing = true;
                    this.errorMessage = null;
                    this.result = null;
                    this.progressMessage = 'æ­£åœ¨ç”Ÿæˆå¸¦è’™ç‰ˆçš„å›¾åƒ...';

                    try {
                        // ç”Ÿæˆå¸¦è’™ç‰ˆçš„å›¾åƒï¼ˆå°†è’™ç‰ˆä½œä¸º alpha é€šé“ï¼‰
                        const maskedImageBlob = await this.generateMaskedImage();

                        // å¼ºåˆ¶ä½¿ç”¨ .png æ‰©å±•åï¼ˆå› ä¸ºéœ€è¦ alpha é€šé“ï¼‰
                        const originalName = this.selectedFile.name;
                        const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.')) || originalName;
                        const maskedImageFile = new File(
                            [maskedImageBlob],
                            'masked_' + nameWithoutExt + '.png',
                            { type: 'image/png' }
                        );

                        this.progressMessage = 'æ­£åœ¨ä¸Šä¼ å¹¶å¤„ç†å›¾åƒæŠ å›¾...';

                        const formData = new FormData();
                        formData.append('image', maskedImageFile); // ä¸Šä¼ å¸¦è’™ç‰ˆçš„å›¾åƒ
                        formData.append('threshold', this.params.threshold);
                        formData.append('alphaMatting', this.params.alphaMatting);
                        formData.append('alphaMattingForegroundThreshold', this.params.alphaMattingForegroundThreshold);
                        formData.append('alphaMattingBackgroundThreshold', this.params.alphaMattingBackgroundThreshold);
                        formData.append('alphaMattingErodeSize', this.params.alphaMattingErodeSize);

                        const response = await axios.post('/api/matting/execute', formData, {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            }
                        });

                        if (response.data.code === 200) {
                            this.result = response.data.data;
                            this.progressMessage = 'å¤„ç†å®Œæˆï¼';
                        } else {
                            this.errorMessage = response.data.message || 'å¤„ç†å¤±è´¥';
                        }
                    } catch (error) {
                        console.error('æŠ å›¾å¤±è´¥:', error);
                        this.errorMessage = error.response?.data?.message || error.message || 'ç½‘ç»œé”™è¯¯';
                    } finally {
                        this.processing = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
