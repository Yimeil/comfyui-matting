<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è’™ç‰ˆæŠ å›¾ - Mask Matting</title>
    <link rel="stylesheet" href="css/common.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        /* é¡µé¢ç‰¹æœ‰æ ·å¼ - è’™ç‰ˆæŠ å›¾é¡µé¢ */

        /* çŠ¶æ€å¾½ç«  */
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            margin-top: 15px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .status-badge.online {
            background: rgba(76, 175, 80, 0.3);
            color: white;
        }

        .status-badge.offline {
            background: rgba(244, 67, 54, 0.3);
            color: white;
        }

        /* æŠ€èƒ½é€‰æ‹©å™¨ */
        .skill-selector {
            margin-bottom: 30px;
        }

        .skill-selector h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .skill-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .skill-btn {
            padding: 15px 30px;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .skill-btn:hover {
            border-color: var(--primary-color);
            background: var(--primary-bg-light);
        }

        .skill-btn.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        /* å·¦å³å¸ƒå±€å®¹å™¨ */
        .main-layout {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }

        .left-panel {
            flex: 1;
            min-width: 0;
        }

        .right-panel {
            width: 300px;
            flex-shrink: 0;
        }

        @media (max-width: 900px) {
            .main-layout {
                flex-direction: column;
            }
            .right-panel {
                width: 100%;
            }
        }

        /* ä¸Šä¼ åŒºåŸŸç‰¹æ®Šæ ·å¼ */
        .upload-area {
            border: 3px dashed var(--border-color);
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-gray);
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: var(--primary-bg-light);
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background: var(--primary-bg-lighter);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            margin-top: 20px;
        }

        /* è’™ç‰ˆç»˜åˆ¶åŒºåŸŸæ ·å¼ */
        .mask-drawing-section {
            margin-top: 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            background: #f9f9ff;
        }

        .mask-drawing-section h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .mask-canvas-container {
            position: relative;
            display: inline-block;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
        }

        .mask-canvas {
            display: block;
            cursor: none; /* éšè—é»˜è®¤å…‰æ ‡ï¼Œæˆ‘ä»¬ä¼šç»˜åˆ¶è‡ªå®šä¹‰å…‰æ ‡ */
            max-width: 100%;
        }

        .brush-cursor {
            position: absolute;
            border: 2px solid #667eea;
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            display: none;
            background: rgba(102, 126, 234, 0.1);
        }

        .mask-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .mask-tool-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .mask-tool-btn:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .mask-tool-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .brush-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brush-size-control label {
            font-weight: 500;
            color: #555;
        }

        .brush-size-control input[type="range"] {
            width: 150px;
        }

        .mask-preview {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .mask-preview h5 {
            margin-bottom: 10px;
            color: #555;
            font-size: 0.9rem;
        }

        .mask-preview canvas {
            max-width: 100%;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        /* å‚æ•°éƒ¨åˆ† */
        .params-section {
            margin-bottom: 30px;
        }

        .params-section h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .param-group {
            margin-bottom: 20px;
        }

        .param-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .param-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
            outline: none;
        }

        .param-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .param-value {
            display: inline-block;
            margin-left: 10px;
            color: var(--primary-color);
            font-weight: bold;
        }

        /* è¿›åº¦æ˜¾ç¤º */
        .progress {
            margin-top: 20px;
            padding: 20px;
            background: var(--primary-bg-light);
            border-radius: 10px;
            text-align: center;
        }

        /* ç»“æœå›¾ç‰‡ */
        .result-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        /* é¡µè„š */
        .footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            opacity: 0.8;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 20px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            flex-shrink: 0;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.3rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            padding: 5px;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .modal-body .mask-canvas-container {
            max-height: calc(90vh - 280px);
            overflow: hidden;
        }

        .modal-body .mask-canvas {
            max-height: calc(90vh - 280px);
            width: auto;
            height: auto;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
            flex-shrink: 0;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }

        /* è’™ç‰ˆç»˜åˆ¶æŒ‰é’® */
        .mask-edit-btn {
            margin-top: 15px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .mask-edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* è’™ç‰ˆçŠ¶æ€æç¤º */
        .mask-status {
            margin-top: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .mask-status.has-mask {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .mask-status.no-mask {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div style="text-align: left; margin-bottom: 15px;">
                <a href="index.html" style="color: white; text-decoration: none; font-size: 0.9rem; opacity: 0.9;">
                    â† è¿”å›é¦–é¡µ
                </a>
            </div>
            <h1>ğŸ¯ è’™ç‰ˆæŠ å›¾å·¥å…·</h1>
            <span class="status-badge">

            </span>
        </div>

        <div class="card">
            <!-- ä½¿ç”¨è¯´æ˜ -->
            <div style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; border-radius: 8px; margin-bottom: 25px; font-size: 14px; color: #0c5460;">
                <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                1. ä¸Šä¼ éœ€è¦æŠ å›¾çš„å›¾ç‰‡<br>
                2. ç‚¹å‡»"ç¼–è¾‘è’™ç‰ˆåŒºåŸŸ"ç”¨ç”»ç¬”æ ‡è®°è¦æŠ å›¾çš„éƒ¨åˆ†<br>
                3. è°ƒæ•´å‚æ•°ï¼ˆå¯é€‰ï¼‰ï¼Œç‚¹å‡»"å¼€å§‹æ‰§è¡Œ"å³å¯
            </div>

            <!-- ä¸»è¦å†…å®¹åŒºåŸŸï¼šå·¦å³å¸ƒå±€ -->
            <div class="main-layout">
                <!-- å·¦ä¾§ï¼šå›¾ç‰‡ä¸Šä¼ å’Œè’™ç‰ˆ -->
                <div class="left-panel">
                    <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                    <div
                        class="upload-area"
                        :class="{ dragover: isDragging }"
                        @click="triggerFileInput"
                        @dragover.prevent="isDragging = true"
                        @dragleave.prevent="isDragging = false"
                        @drop.prevent="handleFileDrop">
                        <div v-if="!previewUrl" class="upload-icon">ğŸ“¤</div>
                        <div v-if="!previewUrl">
                            <p style="font-size: 1.2rem; color: #666; margin-bottom: 10px;">
                                ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡
                            </p>
                            <p style="font-size: 0.9rem; color: #999;">
                                æ”¯æŒ JPG, PNG æ ¼å¼
                            </p>
                        </div>
                        <img v-if="previewUrl" :src="previewUrl" class="preview-image" alt="é¢„è§ˆ">
                        <input
                            type="file"
                            ref="fileInput"
                            @change="handleFileSelect"
                            accept="image/*"
                            style="display: none;">
                    </div>

                    <!-- è’™ç‰ˆç¼–è¾‘æŒ‰é’®ã€æ‰§è¡ŒæŒ‰é’®å’ŒçŠ¶æ€ -->
                    <div v-if="selectedFile && previewUrl" style="text-align: center; margin-top: 15px;">
                        <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 10px;">
                            <button class="mask-edit-btn" @click="openMaskModal">
                                ğŸ¨ ç¼–è¾‘è’™ç‰ˆåŒºåŸŸ
                            </button>
                            <button
                                class="btn btn-primary"
                                @click="executeSkill"
                                :disabled="!selectedFile || processing"
                                style="margin: 0; padding: 12px 25px; font-size: 1rem;">
                                {{ processing ? 'å¤„ç†ä¸­...' : 'ğŸš€ å¼€å§‹æ‰§è¡Œ' }}
                            </button>
                        </div>
                        <div class="mask-status" :class="hasMask ? 'has-mask' : 'no-mask'">
                            {{ hasMask ? 'âœ… å·²è®¾ç½®è’™ç‰ˆåŒºåŸŸ' : 'âš ï¸ æœªè®¾ç½®è’™ç‰ˆï¼Œå°†å¤„ç†æ•´å¼ å›¾ç‰‡' }}
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šå‚æ•°è°ƒæ•´ -->
                <div class="right-panel" v-if="selectedSkill === 'matting'">
                    <div class="params-section" style="margin-bottom: 0;">
                        <h3>âš™ï¸ å‚æ•°è°ƒæ•´</h3>

                        <div class="param-group">
                            <label>
                                SAM é˜ˆå€¼
                                <span class="param-value">{{ params.threshold }}</span>
                            </label>
                            <input
                                type="range"
                                v-model.number="params.threshold"
                                min="0"
                                max="1"
                                step="0.1">
                        </div>

                        <div class="param-group">
                            <label>
                                è’™ç‰ˆæç¤ºé˜ˆå€¼
                                <span class="param-value">{{ params.maskHintThreshold }}</span>
                            </label>
                            <input
                                type="range"
                                v-model.number="params.maskHintThreshold"
                                min="0"
                                max="1"
                                step="0.1">
                        </div>

                        <div class="param-group">
                            <label>
                                è†¨èƒ€
                                <span class="param-value">{{ params.dilation }}</span>
                            </label>
                            <input
                                type="range"
                                v-model.number="params.dilation"
                                min="0"
                                max="20"
                                step="1">
                        </div>

                        <div class="param-group">
                            <label>
                                è¾¹ç•Œæ‰©å±•
                                <span class="param-value">{{ params.bboxExpansion }}</span>
                            </label>
                            <input
                                type="range"
                                v-model.number="params.bboxExpansion"
                                min="0"
                                max="10"
                                step="1">
                        </div>

                        <div class="param-group">
                            <label>
                                è’™ç‰ˆæ‰©å±•
                                <span class="param-value">{{ params.expand }}</span>
                            </label>
                            <input
                                type="range"
                                v-model.number="params.expand"
                                min="-20"
                                max="20"
                                step="1">
                        </div>

                        <div class="param-group">
                            <label>
                                æ¨¡ç³ŠåŠå¾„
                                <span class="param-value">{{ params.blurRadius }}</span>
                            </label>
                            <input
                                type="range"
                                v-model.number="params.blurRadius"
                                min="0"
                                max="10"
                                step="0.5">
                        </div>
                    </div>
                </div>
            </div>

            <!-- è’™ç‰ˆç»˜åˆ¶å¼¹çª— -->
            <div v-if="showMaskModal" class="modal-overlay" @click.self="closeMaskModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>ğŸ¨ è’™ç‰ˆç»˜åˆ¶</h3>
                        <button class="modal-close" @click="closeMaskModal">&times;</button>
                    </div>

                    <div class="modal-body">
                        <p style="margin-bottom: 10px; color: #666; font-size: 0.85rem;">
                            ç”¨<strong>ç”»ç¬”</strong>æ ‡è®°æŠ å›¾åŒºåŸŸï¼ˆé®ç½©æ¶ˆå¤±ï¼‰ï¼Œç”¨<strong>æ©¡çš®æ“¦</strong>æ¢å¤
                        </p>

                        <!-- ç»˜åˆ¶å·¥å…·æ  -->
                        <div class="mask-toolbar">
                            <button
                                class="mask-tool-btn"
                                :class="{ active: maskTool === 'brush' }"
                                @click="selectMaskTool('brush')">
                                ğŸ–Œï¸ ç”»ç¬”
                            </button>
                            <button
                                class="mask-tool-btn"
                                :class="{ active: maskTool === 'eraser' }"
                                @click="selectMaskTool('eraser')">
                                ğŸ§¹ æ©¡çš®æ“¦
                            </button>
                            <button
                                class="mask-tool-btn"
                                @click="clearMask">
                                ğŸ—‘ï¸ æ¸…é™¤è’™ç‰ˆ
                            </button>

                            <div class="brush-size-control">
                                <label>ç”»ç¬”å¤§å°:</label>
                                <input
                                    type="range"
                                    v-model.number="brushSize"
                                    min="5"
                                    max="100"
                                    step="5">
                                <span class="param-value">{{ brushSize }}px</span>
                            </div>

                            <div class="brush-size-control">
                                <label>é®ç½©é¢œè‰²:</label>
                                <input
                                    type="color"
                                    v-model="overlayColor"
                                    @input="redrawDisplayCanvas"
                                    style="width: 40px; height: 30px; border: none; cursor: pointer;">
                            </div>
                        </div>

                        <!-- Canvas ç”»å¸ƒ -->
                        <div class="mask-canvas-container">
                            <canvas
                                ref="displayCanvas"
                                class="mask-canvas"
                                @mousedown="startDrawing"
                                @mousemove="handleMouseMove"
                                @mouseup="stopDrawing"
                                @mouseleave="handleMouseLeave"
                                @mouseenter="handleMouseEnter"
                                @touchstart="startDrawing"
                                @touchmove="draw"
                                @touchend="stopDrawing">
                            </canvas>
                            <canvas ref="maskCanvas" style="display: none;"></canvas>
                            <div ref="brushCursor" class="brush-cursor"></div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="cancelMask">
                            å–æ¶ˆ
                        </button>
                        <button class="btn btn-success" @click="confirmMask">
                            âœ… ç¡®è®¤è’™ç‰ˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div v-if="processing" class="progress">
                <div class="spinner"></div>
                <p>{{ progressMessage }}</p>
            </div>

            <!-- é”™è¯¯æ˜¾ç¤º -->
            <div v-if="errorMessage" class="error-message">
                âŒ {{ errorMessage }}
            </div>

            <!-- ç»“æœæ˜¾ç¤º -->
            <div v-if="result" class="result-section">
                <h3>âœ… å¤„ç†ç»“æœ</h3>
                <img :src="result.remoteUrl" class="result-image" alt="å¤„ç†ç»“æœ">
                <div class="result-info">
                    <p><strong>è¾“å‡ºæ–‡ä»¶:</strong> {{ result.outputFilename }}</p>
                    <p><strong>æ‰§è¡Œæ—¶é—´:</strong> {{ result.executionTime }}ms</p>
                    <p><strong>Prompt ID:</strong> {{ result.promptId }}</p>
                    <p>
                        <strong>å›¾ç‰‡URL:</strong>
                        <a :href="result.remoteUrl" target="_blank" style="color: #667eea; word-break: break-all;">{{ result.remoteUrl }}</a>
                    </p>
                    <p style="margin-top: 15px;">
                        <button @click="downloadResult" style="padding: 10px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem;">
                            ğŸ“¥ ä¸‹è½½å›¾ç‰‡
                        </button>
                    </p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Powered by Vue 3 + Spring Boot + ComfyUI</p>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    serverStatus: false,
                    selectedSkill: 'matting',
                    selectedFile: null,
                    previewUrl: null,
                    isDragging: false,
                    processing: false,
                    progressMessage: '',
                    errorMessage: null,
                    result: null,
                    params: {
                        // SAM æ£€æµ‹å‚æ•°ï¼ˆå¯¹åº”å·¥ä½œæµèŠ‚ç‚¹10ï¼‰
                        threshold: 1,
                        maskHintThreshold: 0.6,
                        dilation: 0,
                        bboxExpansion: 1,
                        // è’™ç‰ˆå¤„ç†å‚æ•°ï¼ˆå¯¹åº”å·¥ä½œæµèŠ‚ç‚¹23ï¼‰
                        expand: -3,
                        blurRadius: 1
                    },
                    // è’™ç‰ˆç»˜åˆ¶ç›¸å…³
                    maskTool: 'brush',
                    brushSize: 30,
                    overlayColor: '#ff0000', // é®ç½©é¢œè‰²ï¼Œé»˜è®¤çº¢è‰²
                    isDrawing: false,
                    maskCanvas: null,
                    maskCtx: null,
                    displayCanvas: null, // æ˜¾ç¤ºå±‚ Canvas
                    displayCtx: null,    // æ˜¾ç¤ºå±‚ Context
                    originalImage: null,
                    lastX: 0,
                    lastY: 0,
                    pendingUpdate: false, // æ˜¯å¦æœ‰å¾…æ›´æ–°çš„æ˜¾ç¤º
                    // å¼¹çª—ç›¸å…³
                    showMaskModal: false,
                    hasMask: false,
                    maskBackup: null, // ç”¨äºå–æ¶ˆæ—¶æ¢å¤
                    savedMaskData: null // ä¿å­˜ç¡®è®¤åçš„è’™ç‰ˆæ•°æ®
                };
            },
            mounted() {
                this.checkServerStatus();
            },
            methods: {
                async checkServerStatus() {
                    try {
                        const response = await axios.get('/api/matting/status');
                        this.serverStatus = response.data.code === 200;
                    } catch (error) {
                        this.serverStatus = false;
                        console.error('æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€å¤±è´¥:', error);
                    }
                },
                selectSkill(skill) {
                    this.selectedSkill = skill;
                    this.result = null;
                    this.errorMessage = null;
                },
                triggerFileInput() {
                    this.$refs.fileInput.click();
                },
                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.loadFile(file);
                    }
                },
                handleFileDrop(event) {
                    this.isDragging = false;
                    const file = event.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.loadFile(file);
                    }
                },
                loadFile(file) {
                    this.selectedFile = file;
                    this.previewUrl = URL.createObjectURL(file);
                    this.result = null;
                    this.errorMessage = null;

                    // åŠ è½½å›¾åƒåˆ° Canvas
                    const img = new Image();
                    img.onload = () => {
                        this.originalImage = img;
                        this.$nextTick(() => {
                            this.initMaskCanvas(img);
                        });
                    };
                    img.src = this.previewUrl;
                },
                // åˆå§‹åŒ–è’™ç‰ˆ Canvas
                initMaskCanvas(img) {
                    const maskCanvas = this.$refs.maskCanvas;
                    const displayCanvas = this.$refs.displayCanvas;
                    if (!maskCanvas || !displayCanvas) return;

                    // è®¾ç½® Canvas å°ºå¯¸ä¸å›¾åƒä¸€è‡´
                    const maxWidth = 800;
                    let width = img.width;
                    let height = img.height;

                    // ç¼©æ”¾å›¾åƒä»¥é€‚åº”æ˜¾ç¤º
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    // è®¾ç½®ä¸¤ä¸ª Canvas çš„å°ºå¯¸
                    maskCanvas.width = width;
                    maskCanvas.height = height;
                    displayCanvas.width = width;
                    displayCanvas.height = height;

                    this.maskCtx = maskCanvas.getContext('2d');
                    this.displayCtx = displayCanvas.getContext('2d');

                    // é…ç½®ç»˜åˆ¶å±æ€§ä»¥è·å¾—å¹³æ»‘æ•ˆæœ
                    this.maskCtx.lineJoin = 'round';
                    this.maskCtx.lineCap = 'round';

                    // åˆå§‹åŒ–è’™ç‰ˆä¸ºå…¨é»‘ï¼ˆé»˜è®¤ä¸å¤„ç†ä»»ä½•åŒºåŸŸï¼Œç”¨æˆ·ç”¨ç”»ç¬”æ ‡è®°è¦æŠ å›¾çš„åŒºåŸŸï¼‰
                    this.maskCtx.fillStyle = 'black';
                    this.maskCtx.fillRect(0, 0, width, height);

                    // ç»˜åˆ¶æ˜¾ç¤ºæ•ˆæœ
                    this.redrawDisplayCanvas();
                    this.updateMaskPreview();
                },
                // é‡ç»˜æ˜¾ç¤º Canvas
                redrawDisplayCanvas() {
                    const displayCanvas = this.$refs.displayCanvas;
                    const maskCanvas = this.$refs.maskCanvas;
                    const ctx = this.displayCtx;
                    if (!displayCanvas || !maskCanvas || !ctx || !this.originalImage) return;

                    // æ¸…ç©ºæ˜¾ç¤º Canvas
                    ctx.clearRect(0, 0, displayCanvas.width, displayCanvas.height);

                    // 1. ç»˜åˆ¶åŸå›¾
                    ctx.drawImage(this.originalImage, 0, 0, displayCanvas.width, displayCanvas.height);

                    // 2. è·å–è’™ç‰ˆæ•°æ®
                    const maskData = this.maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);

                    // 3. åˆ›å»ºä¸´æ—¶ Canvas ç”¨äºç»˜åˆ¶åŠé€æ˜é®ç½©
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = displayCanvas.width;
                    tempCanvas.height = displayCanvas.height;
                    const tempCtx = tempCanvas.getContext('2d');

                    // è§£æé®ç½©é¢œè‰²
                    const colorHex = this.overlayColor;
                    const r = parseInt(colorHex.slice(1, 3), 16);
                    const g = parseInt(colorHex.slice(3, 5), 16);
                    const b = parseInt(colorHex.slice(5, 7), 16);

                    // åˆ›å»ºé®ç½©å±‚
                    const overlayData = tempCtx.createImageData(displayCanvas.width, displayCanvas.height);

                    for (let i = 0; i < maskData.data.length; i += 4) {
                        const maskValue = maskData.data[i]; // 0=é»‘è‰²/ä¸å¤„ç†, 255=ç™½è‰²/å¤„ç†

                        if (maskValue < 128) {
                            // é»‘è‰²è’™ç‰ˆåŒºåŸŸ -> æ˜¾ç¤ºåŠé€æ˜é®ç½©
                            overlayData.data[i] = r;       // R
                            overlayData.data[i + 1] = g;   // G
                            overlayData.data[i + 2] = b;   // B
                            overlayData.data[i + 3] = 120; // åŠé€æ˜
                        } else {
                            // ç™½è‰²è’™ç‰ˆåŒºåŸŸ -> é€æ˜ï¼ˆä¸é®ç½©ï¼‰
                            overlayData.data[i] = 0;
                            overlayData.data[i + 1] = 0;
                            overlayData.data[i + 2] = 0;
                            overlayData.data[i + 3] = 0;
                        }
                    }

                    // å°†é®ç½©å±‚ç»˜åˆ¶åˆ°ä¸´æ—¶ Canvas
                    tempCtx.putImageData(overlayData, 0, 0);

                    // 4. å°†é®ç½©å±‚å åŠ åˆ°æ˜¾ç¤º Canvasï¼ˆåœ¨åŸå›¾ä¹‹ä¸Šï¼‰
                    ctx.drawImage(tempCanvas, 0, 0);
                },
                // é€‰æ‹©ç»˜åˆ¶å·¥å…·
                selectMaskTool(tool) {
                    this.maskTool = tool;
                },
                // å¼€å§‹ç»˜åˆ¶
                startDrawing(event) {
                    event.preventDefault();
                    this.isDrawing = true;

                    const displayCanvas = this.$refs.displayCanvas;
                    const rect = displayCanvas.getBoundingClientRect();

                    let clientX, clientY;
                    if (event.type.startsWith('touch')) {
                        clientX = event.touches[0].clientX;
                        clientY = event.touches[0].clientY;
                    } else {
                        clientX = event.clientX;
                        clientY = event.clientY;
                    }

                    this.lastX = (clientX - rect.left) * (displayCanvas.width / rect.width);
                    this.lastY = (clientY - rect.top) * (displayCanvas.height / rect.height);

                    // åœ¨èµ·ç‚¹ç»˜åˆ¶ä¸€ä¸ªåœ†ç‚¹
                    this.drawOnMask(this.lastX, this.lastY, this.lastX, this.lastY);
                },
                // å¤„ç†é¼ æ ‡ç§»åŠ¨ï¼ˆåŒ…æ‹¬ç»˜åˆ¶å’Œå…‰æ ‡æ›´æ–°ï¼‰
                handleMouseMove(event) {
                    this.updateBrushCursor(event);
                    this.draw(event);
                },
                // ç»˜åˆ¶
                draw(event) {
                    if (!this.isDrawing) return;

                    event.preventDefault();
                    const displayCanvas = this.$refs.displayCanvas;
                    const rect = displayCanvas.getBoundingClientRect();

                    let clientX, clientY;
                    if (event.type.startsWith('touch')) {
                        clientX = event.touches[0].clientX;
                        clientY = event.touches[0].clientY;
                    } else {
                        clientX = event.clientX;
                        clientY = event.clientY;
                    }

                    const x = (clientX - rect.left) * (displayCanvas.width / rect.width);
                    const y = (clientY - rect.top) * (displayCanvas.height / rect.height);

                    // ä»ä¸Šä¸€ä¸ªç‚¹ç»˜åˆ¶åˆ°å½“å‰ç‚¹
                    this.drawOnMask(this.lastX, this.lastY, x, y);

                    this.lastX = x;
                    this.lastY = y;
                },
                // æ›´æ–°ç”»ç¬”å…‰æ ‡
                updateBrushCursor(event) {
                    const cursor = this.$refs.brushCursor;
                    const displayCanvas = this.$refs.displayCanvas;
                    if (!cursor || !displayCanvas) return;

                    const rect = displayCanvas.getBoundingClientRect();
                    cursor.style.left = (event.clientX - rect.left) + 'px';
                    cursor.style.top = (event.clientY - rect.top) + 'px';
                    cursor.style.width = this.brushSize + 'px';
                    cursor.style.height = this.brushSize + 'px';
                },
                // é¼ æ ‡è¿›å…¥ç”»å¸ƒ
                handleMouseEnter(event) {
                    const cursor = this.$refs.brushCursor;
                    if (cursor) {
                        cursor.style.display = 'block';
                        this.updateBrushCursor(event);
                    }
                },
                // é¼ æ ‡ç¦»å¼€ç”»å¸ƒ
                handleMouseLeave() {
                    const cursor = this.$refs.brushCursor;
                    if (cursor) {
                        cursor.style.display = 'none';
                    }
                    this.stopDrawing();
                },
                // åœ¨è’™ç‰ˆä¸Šç»˜åˆ¶
                drawOnMask(x1, y1, x2, y2) {
                    const ctx = this.maskCtx;
                    if (!ctx) return;

                    // è®¾ç½®ç”»ç¬”å±æ€§
                    ctx.strokeStyle = this.maskTool === 'brush' ? 'white' : 'black';
                    ctx.lineWidth = this.brushSize;
                    ctx.lineJoin = 'round';
                    ctx.lineCap = 'round';

                    // ç»˜åˆ¶çº¿æ¡
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();

                    // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ›´æ–°é¢‘ç‡
                    this.scheduleDisplayUpdate();
                },
                // è°ƒåº¦æ˜¾ç¤ºæ›´æ–°ï¼ˆä½¿ç”¨ RAF é˜²æ­¢è¿‡åº¦ç»˜åˆ¶ï¼‰
                scheduleDisplayUpdate() {
                    if (this.pendingUpdate) return;

                    this.pendingUpdate = true;
                    requestAnimationFrame(() => {
                        this.redrawDisplayCanvas();
                        this.updateMaskPreview();
                        this.pendingUpdate = false;
                    });
                },
                // åœæ­¢ç»˜åˆ¶
                stopDrawing() {
                    this.isDrawing = false;
                },
                // æ¸…é™¤è’™ç‰ˆ
                clearMask() {
                    if (!this.originalImage) return;
                    this.initMaskCanvas(this.originalImage);
                },
                // æ‰“å¼€è’™ç‰ˆå¼¹çª—
                openMaskModal() {
                    this.showMaskModal = true;

                    // ç­‰å¾…å¼¹çª—æ¸²æŸ“ååˆå§‹åŒ– Canvas
                    this.$nextTick(() => {
                        if (this.originalImage) {
                            this.initMaskCanvas(this.originalImage);
                            // æ¢å¤ä¹‹å‰ä¿å­˜çš„è’™ç‰ˆæ•°æ®
                            if (this.savedMaskData && this.maskCtx) {
                                // åˆ›å»ºä¸´æ—¶canvasæ¥ç¼©æ”¾è’™ç‰ˆ
                                const tempMask = document.createElement('canvas');
                                tempMask.width = this.savedMaskData.width;
                                tempMask.height = this.savedMaskData.height;
                                const tempCtx = tempMask.getContext('2d');
                                tempCtx.putImageData(this.savedMaskData.imageData, 0, 0);

                                // ç¼©æ”¾åˆ°å½“å‰canvaså°ºå¯¸
                                const maskCanvas = this.$refs.maskCanvas;
                                this.maskCtx.drawImage(tempMask, 0, 0, maskCanvas.width, maskCanvas.height);
                                this.redrawDisplayCanvas();
                            }
                            // å¤‡ä»½å½“å‰çŠ¶æ€ç”¨äºå–æ¶ˆæ¢å¤
                            const maskCanvas = this.$refs.maskCanvas;
                            if (maskCanvas && this.maskCtx) {
                                this.maskBackup = this.maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);
                            }
                        }
                    });
                },
                // å…³é—­è’™ç‰ˆå¼¹çª—
                closeMaskModal() {
                    this.showMaskModal = false;
                },
                // ç¡®è®¤è’™ç‰ˆ
                confirmMask() {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç»˜åˆ¶è’™ç‰ˆï¼ˆæ£€æŸ¥æ˜¯å¦æœ‰ç™½è‰²åƒç´ ï¼‰
                    const maskCanvas = this.$refs.maskCanvas;
                    if (maskCanvas && this.maskCtx) {
                        const imageData = this.maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);
                        let hasWhite = false;
                        for (let i = 0; i < imageData.data.length; i += 4) {
                            if (imageData.data[i] > 128) {
                                hasWhite = true;
                                break;
                            }
                        }
                        this.hasMask = hasWhite;

                        // ä¿å­˜è’™ç‰ˆæ•°æ®å’Œå°ºå¯¸ï¼Œä¾›åç»­ç”Ÿæˆå›¾åƒä½¿ç”¨
                        this.savedMaskData = {
                            imageData: imageData,
                            width: maskCanvas.width,
                            height: maskCanvas.height
                        };
                    }

                    this.showMaskModal = false;
                    this.maskBackup = null;
                },
                // å–æ¶ˆè’™ç‰ˆç¼–è¾‘
                cancelMask() {
                    // æ¢å¤å¤‡ä»½çš„è’™ç‰ˆ
                    if (this.maskBackup && this.maskCtx) {
                        this.maskCtx.putImageData(this.maskBackup, 0, 0);
                    }
                    this.showMaskModal = false;
                    this.maskBackup = null;
                },
                // æ›´æ–°è’™ç‰ˆé¢„è§ˆï¼ˆé¢„è§ˆåŒºåŸŸå·²ç§»é™¤ï¼Œä¿ç•™ç©ºæ–¹æ³•ä»¥å…¼å®¹è°ƒç”¨ï¼‰
                updateMaskPreview() {
                    // é¢„è§ˆåŒºåŸŸå·²ç§»é™¤
                },
                // ç”Ÿæˆå¸¦è’™ç‰ˆçš„å›¾åƒï¼ˆComfyUI Alphaè’™ç‰ˆæ ¼å¼ï¼‰
                async generateMaskedImage() {
                    return new Promise((resolve) => {
                        if (!this.originalImage) {
                            resolve(null);
                            return;
                        }

                        const resultCanvas = document.createElement('canvas');
                        resultCanvas.width = this.originalImage.width;
                        resultCanvas.height = this.originalImage.height;
                        const ctx = resultCanvas.getContext('2d');

                        // å…ˆç»˜åˆ¶åŸå›¾
                        ctx.drawImage(this.originalImage, 0, 0);

                        // å¦‚æœæœ‰ä¿å­˜çš„è’™ç‰ˆæ•°æ®ï¼Œåº”ç”¨è’™ç‰ˆ
                        if (this.savedMaskData && this.hasMask) {
                            // å°†è’™ç‰ˆç¼©æ”¾åˆ°åŸå§‹å°ºå¯¸
                            const scaledMask = document.createElement('canvas');
                            scaledMask.width = this.originalImage.width;
                            scaledMask.height = this.originalImage.height;
                            const scaledCtx = scaledMask.getContext('2d');

                            // å…ˆå°†ä¿å­˜çš„è’™ç‰ˆæ•°æ®ç»˜åˆ¶åˆ°ä¸´æ—¶canvas
                            const tempMask = document.createElement('canvas');
                            tempMask.width = this.savedMaskData.width;
                            tempMask.height = this.savedMaskData.height;
                            const tempCtx = tempMask.getContext('2d');
                            tempCtx.putImageData(this.savedMaskData.imageData, 0, 0);

                            // ç¼©æ”¾åˆ°åŸå›¾å°ºå¯¸
                            scaledCtx.drawImage(tempMask, 0, 0, scaledMask.width, scaledMask.height);

                            // ComfyUI Alphaè’™ç‰ˆæ ¼å¼ï¼ˆæ¨èï¼‰ï¼š
                            // RGB = åŸå›¾å®Œæ•´é¢œè‰²ä¿¡æ¯ï¼ˆä¿æŒä¸å˜ï¼‰
                            // Alpha = è’™ç‰ˆæ ‡è®°ï¼ˆ128=è¦å¤„ç†çš„åŒºåŸŸï¼Œ255=ä¸å¤„ç†ï¼‰

                            const resultData = ctx.getImageData(0, 0, resultCanvas.width, resultCanvas.height);
                            const scaledMaskData = scaledCtx.getImageData(0, 0, scaledMask.width, scaledMask.height);

                            for (let i = 0; i < resultData.data.length; i += 4) {
                                const maskValue = scaledMaskData.data[i]; // 0=é»‘è‰²/ä¸æŠ å›¾, 255=ç™½è‰²/è¦æŠ å›¾

                                // RGBé€šé“ä¿æŒåŸå›¾ä¸å˜ï¼ˆdrawImageå·²ç»ç»˜åˆ¶äº†åŸå›¾ï¼‰

                                if (maskValue > 128) {
                                    // ç™½è‰²è’™ç‰ˆåŒºåŸŸï¼ˆç”¨æˆ·ç”»ç¬”æ ‡è®°çš„ï¼Œè¦æŠ å›¾ï¼‰
                                    // Alphaè®¾ä¸º128ï¼ˆåŠé€æ˜ï¼Œä½œä¸ºè’™ç‰ˆæ ‡è®°ï¼‰
                                    resultData.data[i + 3] = 128;
                                } else {
                                    // é»‘è‰²è’™ç‰ˆåŒºåŸŸï¼ˆèƒŒæ™¯ï¼Œä¸æŠ å›¾ï¼‰
                                    // Alphaè®¾ä¸º255ï¼ˆå®Œå…¨ä¸é€æ˜ï¼Œä¿ç•™åŸå›¾ï¼‰
                                    resultData.data[i + 3] = 255;
                                }
                            }

                            ctx.putImageData(resultData, 0, 0);
                        }

                        // è½¬æ¢ä¸º PNG Blob
                        resultCanvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/png');
                    });
                },
                async executeSkill() {
                    if (!this.selectedFile) {
                        this.errorMessage = 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡';
                        return;
                    }

                    this.processing = true;
                    this.errorMessage = null;
                    this.result = null;
                    this.progressMessage = 'æ­£åœ¨ç”Ÿæˆå¸¦è’™ç‰ˆçš„å›¾åƒ...';

                    try {
                        // ç”Ÿæˆå¸¦è’™ç‰ˆçš„å›¾åƒï¼ˆå°†è’™ç‰ˆä½œä¸º alpha é€šé“ï¼‰
                        const maskedImageBlob = await this.generateMaskedImage();

                        // ä½¿ç”¨ clipspace-mask.png æ ¼å¼çš„æ–‡ä»¶åï¼ˆComfyUI è¯†åˆ«çš„è’™ç‰ˆæ ¼å¼ï¼‰
                        const maskedImageFile = new File(
                            [maskedImageBlob],
                            'clipspace-mask-' + Date.now() + '.png',
                            { type: 'image/png' }
                        );

                        this.progressMessage = 'æ­£åœ¨ä¸Šä¼ å¹¶å¤„ç†å›¾åƒæŠ å›¾...';

                        const formData = new FormData();
                        formData.append('image', maskedImageFile); // ä¸Šä¼ å¸¦è’™ç‰ˆçš„å›¾åƒ
                        // SAM æ£€æµ‹å‚æ•°
                        formData.append('threshold', this.params.threshold);
                        formData.append('maskHintThreshold', this.params.maskHintThreshold);
                        formData.append('dilation', this.params.dilation);
                        formData.append('bboxExpansion', this.params.bboxExpansion);
                        // è’™ç‰ˆå¤„ç†å‚æ•°
                        formData.append('expand', this.params.expand);
                        formData.append('blurRadius', this.params.blurRadius);

                        const response = await axios.post('/api/matting/execute', formData, {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            }
                        });

                        if (response.data.code === 200) {
                            this.result = response.data.data;
                            this.progressMessage = 'å¤„ç†å®Œæˆï¼';
                        } else {
                            this.errorMessage = response.data.message || 'å¤„ç†å¤±è´¥';
                        }
                    } catch (error) {
                        console.error('æŠ å›¾å¤±è´¥:', error);
                        this.errorMessage = error.response?.data?.message || error.message || 'ç½‘ç»œé”™è¯¯';
                    } finally {
                        this.processing = false;
                    }
                },
                downloadResult() {
                    if (!this.result || !this.result.remoteUrl || !this.result.outputFilename) {
                        alert('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡');
                        return;
                    }

                    const proxyUrl = `/api/matting/download?url=${encodeURIComponent(this.result.remoteUrl)}&filename=${encodeURIComponent(this.result.outputFilename)}`;
                    const a = document.createElement('a');
                    a.href = proxyUrl;
                    a.download = this.result.outputFilename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
