<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen å¤šè§’åº¦ç¼–è¾‘</title>
    <link rel="stylesheet" href="css/common.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        /* é¡µé¢ç‰¹æœ‰æ ·å¼ - åŒé¢æ¿å¸ƒå±€ */
        #app {
            max-width: 1400px;
        }

        .card {
            padding: 30px;
            max-width: none;
        }

        .main-layout {
            display: flex;
            gap: 30px;
        }

        .left-panel {
            flex: 1;
            min-width: 0;
        }

        .right-panel {
            width: 500px;
            flex-shrink: 0;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .right-panel-placeholder {
            background: var(--bg-section);
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            color: var(--text-muted);
        }

        .right-panel-placeholder .icon {
            font-size: 4rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        @media (max-width: 1000px) {
            .main-layout {
                flex-direction: column;
            }
            .right-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>

        <div class="header">
            <h1>ğŸ¨ Qwen å¤šè§’åº¦ç¼–è¾‘</h1>
            <p>AIé©±åŠ¨çš„æ™ºèƒ½å›¾åƒåœºæ™¯ç¼–è¾‘ï¼Œä¿æŒç‰©ä½“æ•°é‡å’ŒçœŸå®æ¯”ä¾‹</p>
        </div>

        <div class="card">
            <div class="main-layout">
                <!-- å·¦ä¾§é¢æ¿ï¼šè¾“å…¥å’Œé…ç½® -->
                <div class="left-panel">
                    <!-- å›¾ç‰‡ä¸Šä¼  -->
                    <div class="form-section">
                        <h3>ğŸ“ ä¸Šä¼ å›¾ç‰‡</h3>
                        <div
                            class="file-upload-area"
                            :class="{ 'has-file': selectedFile, 'dragover': isDragging }"
                            @click="triggerFileInput"
                            @dragover.prevent="isDragging = true"
                            @dragleave.prevent="isDragging = false"
                            @drop.prevent="handleFileDrop"
                        >
                            <div class="upload-icon">{{ selectedFile ? 'âœ…' : 'ğŸ“¤' }}</div>
                            <div>
                                <strong>{{ selectedFile ? selectedFile.name : 'ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡' }}</strong>
                            </div>
                            <div class="hint-text" v-if="!selectedFile">
                                æ”¯æŒ JPGã€PNG æ ¼å¼
                            </div>
                        </div>
                        <input
                            type="file"
                            ref="fileInput"
                            accept="image/*"
                            style="display: none;"
                            @change="handleFileSelect"
                        >

                        <div v-if="previewUrl" class="preview-container">
                            <img :src="previewUrl" alt="é¢„è§ˆå›¾" class="preview-image">
                        </div>
                    </div>

                    <!-- ç¼–è¾‘æŒ‡ä»¤ -->
                    <div class="form-section">
                        <h3>âœï¸ ç¼–è¾‘æŒ‡ä»¤</h3>
                        <div class="form-group">
                            <label>ç¼–è¾‘å†…å®¹æè¿°</label>
                            <textarea
                                v-model="params.editInstruction"
                                placeholder="ä¾‹å¦‚ï¼šå°†å›¾ä¸­æ‰€æœ‰ç‰©å“æŒ‰ç…§å…¶çœŸå®ä¸–ç•Œçš„æ­£å¸¸å°ºå¯¸æ¯”ä¾‹ï¼Œåˆç†æ‘†æ”¾åœ¨å„¿ç«¥ä¹¦æ¡Œä¸Š"
                            ></textarea>
                            <div class="hint-text">æè¿°ä½ æƒ³è¦çš„ç¼–è¾‘æ•ˆæœï¼ŒAIä¼šä¿æŒç‰©ä½“æ•°é‡å’ŒçœŸå®æ¯”ä¾‹</div>
                        </div>

                        <div class="form-group">
                            <label>ç”Ÿæˆæ‰¹æ¬¡</label>
                            <input
                                type="number"
                                v-model.number="params.repeatAmount"
                                min="1"
                                max="10"
                                placeholder="1-10"
                            >
                            <div class="hint-text">ç”Ÿæˆå¤šä¸ªä¸åŒè§’åº¦çš„ç»“æœï¼Œå»ºè®®1-4æ‰¹æ¬¡</div>
                        </div>
                    </div>

                    <!-- æ‰§è¡ŒæŒ‰é’® -->
                    <button
                        class="btn-primary"
                        @click="executeEdit"
                        :disabled="!selectedFile || processing"
                    >
                        <span v-if="processing">
                            <span class="spinner"></span> å¤„ç†ä¸­...
                        </span>
                        <span v-else>ğŸš€ å¼€å§‹ç¼–è¾‘</span>
                    </button>

                    <div v-if="progressMessage" class="progress-message">
                        {{ progressMessage }}
                    </div>

                    <div v-if="errorMessage" class="error-message">
                        âŒ {{ errorMessage }}
                    </div>
                </div>

                <!-- å³ä¾§é¢æ¿ï¼šç»“æœå±•ç¤º -->
                <div class="right-panel">
                    <!-- ç»“æœå±•ç¤º -->
                    <div v-if="result && result.success" class="result-panel">
                        <h3>âœ… ç¼–è¾‘å®Œæˆ ({{ result.images ? result.images.length : 1 }}å¼ )</h3>

                        <!-- å¤šå¼ å›¾ç‰‡å±•ç¤º -->
                        <div v-if="result.images && result.images.length > 0">
                            <div v-for="(image, index) in result.images" :key="index" style="margin-bottom: 20px;">
                                <h4 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 8px;">
                                    ç»“æœ {{ index + 1 }}
                                </h4>
                                <img :src="image.remoteUrl" :alt="'ç¼–è¾‘ç»“æœ ' + (index + 1)" class="result-image">
                                <div style="margin-top: 8px; text-align: center;">
                                    <a
                                        :href="getDownloadUrl(image)"
                                        :download="image.filename"
                                        class="btn-download"
                                        style="display: inline-block; padding: 6px 16px; font-size: 0.85rem;"
                                    >
                                        ğŸ’¾ ä¸‹è½½
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- å•å¼ å›¾ç‰‡å±•ç¤ºï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰ -->
                        <div v-else>
                            <img :src="result.remoteUrl" alt="ç¼–è¾‘ç»“æœ" class="result-image">
                        </div>

                        <div class="result-info">
                            <div class="info-item">
                                <strong>ä»»åŠ¡ID:</strong> {{ result.promptId }}
                            </div>
                            <div class="info-item">
                                <strong>å¤„ç†æ—¶é—´:</strong> {{ formatTime(result.executionTime) }}
                            </div>
                        </div>
                    </div>

                    <!-- å ä½ç¬¦ -->
                    <div v-else class="right-panel-placeholder">
                        <div class="icon">ğŸ¨</div>
                        <p>ç¼–è¾‘ç»“æœå°†åœ¨æ­¤å¤„æ˜¾ç¤º</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    selectedFile: null,
                    previewUrl: null,
                    isDragging: false,
                    processing: false,
                    progressMessage: '',
                    errorMessage: '',
                    result: null,
                    params: {
                        editInstruction: 'å°†å›¾ä¸­æ‰€æœ‰ç‰©å“æŒ‰ç…§å…¶çœŸå®ä¸–ç•Œçš„æ­£å¸¸å°ºå¯¸æ¯”ä¾‹ï¼Œåˆç†æ‘†æ”¾åœ¨å„¿ç«¥ä¹¦æ¡Œä¸Š',
                        repeatAmount: 4
                    }
                };
            },
            methods: {
                getDownloadUrl(image) {
                    if (!image || !image.remoteUrl) return '';
                    return `/api/matting/download?url=${encodeURIComponent(image.remoteUrl)}&filename=${encodeURIComponent(image.filename)}`;
                },
                triggerFileInput() {
                    this.$refs.fileInput.click();
                },
                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.setFile(file);
                    }
                },
                handleFileDrop(event) {
                    this.isDragging = false;
                    const file = event.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.setFile(file);
                    }
                },
                setFile(file) {
                    this.selectedFile = file;
                    this.previewUrl = URL.createObjectURL(file);
                    this.result = null;
                    this.errorMessage = '';
                },
                async executeEdit() {
                    if (!this.selectedFile) {
                        this.errorMessage = 'è¯·å…ˆä¸Šä¼ å›¾ç‰‡';
                        return;
                    }

                    this.processing = true;
                    this.progressMessage = 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡å¹¶å¤„ç†...';
                    this.errorMessage = '';
                    this.result = null;

                    try {
                        const formData = new FormData();
                        formData.append('image', this.selectedFile);

                        // åªæ·»åŠ ç”¨æˆ·é…ç½®çš„å‚æ•°
                        if (this.params.editInstruction) {
                            formData.append('editInstruction', this.params.editInstruction);
                        }
                        if (this.params.repeatAmount) {
                            formData.append('repeatAmount', this.params.repeatAmount);
                        }

                        const response = await axios.post('/api/qwen/edit-angles', formData, {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            },
                            timeout: 600000 // 10åˆ†é’Ÿè¶…æ—¶
                        });

                        if (response.data.code === 200 && response.data.data) {
                            this.result = response.data.data;
                            this.progressMessage = 'âœ… ç¼–è¾‘å®Œæˆï¼';
                            setTimeout(() => {
                                this.progressMessage = '';
                            }, 3000);
                        } else {
                            this.errorMessage = response.data.message || 'ç¼–è¾‘å¤±è´¥';
                        }
                    } catch (error) {
                        console.error('ç¼–è¾‘å¤±è´¥:', error);
                        this.errorMessage = error.response?.data?.message || error.message || 'ç¼–è¾‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                    } finally {
                        this.processing = false;
                    }
                },
                formatTime(ms) {
                    const seconds = Math.floor(ms / 1000);
                    if (seconds < 60) {
                        return `${seconds}ç§’`;
                    }
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    return `${minutes}åˆ†${remainingSeconds}ç§’`;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
