# 节点参数详细调整指南

## 目录
1. [SAM 检测器参数](#sam-检测器参数)
2. [蒙版转 SEGS 参数](#蒙版转-segs-参数)
3. [形态学处理参数](#形态学处理参数)
4. [蒙版扩展与模糊参数](#蒙版扩展与模糊参数)
5. [实战调参案例](#实战调参案例)

---

## SAM 检测器参数

### 节点 10: SAMDetectorSegmented

#### detection_hint (检测提示模式)

**当前值**: `"center-1"`

**可选值**:
- `"center-1"`: 使用中心点作为正样本提示
- `"center-2"`: 使用中心点+边界点
- `"center-3"`: 使用更多采样点
- `"none"`: 不使用提示点

**何时调整**:
- 如果分割不准确，尝试 `"center-2"` 或 `"center-3"`
- 如果有明确的蒙版区域，保持 `"center-1"`

**示例**:
```json
"detection_hint": "center-2"  // 使用更多提示点，提高准确性
```

---

#### dilation (膨胀系数)

**当前值**: `0`

**取值范围**: `-20` 到 `20`（整数）

**作用**: 在 SAM 检测前对输入蒙版进行膨胀或腐蚀
- `正值`: 膨胀蒙版（扩大检测区域）
- `0`: 不改变
- `负值`: 腐蚀蒙版（缩小检测区域）

**调整建议**:
```json
// 对象边缘模糊，需要扩大检测范围
"dilation": 5

// 蒙版包含过多背景，需要收缩
"dilation": -3

// 蒙版准确，不需要调整
"dilation": 0
```

---

#### threshold (阈值)

**当前值**: `1`

**取值范围**: `0.0` 到 `1.0`（浮点数）

**作用**: SAM 分割的置信度阈值
- 越高：分割越保守，只保留高置信度区域
- 越低：分割越激进，可能包含更多区域

**调整建议**:
```json
// 分割不完整，降低阈值
"threshold": 0.7

// 分割包含太多杂质，提高阈值
"threshold": 1.2

// 默认值，适合大多数情况
"threshold": 1.0
```

---

#### bbox_expansion (边界框扩展)

**当前值**: `1`

**取值范围**: `0.1` 到 `5.0`（浮点数）

**作用**: 控制边界框的扩展倍数
- `1.0`: 不扩展
- `>1.0`: 扩大边界框，捕获更多上下文
- `<1.0`: 缩小边界框

**调整建议**:
```json
// 对象较大或边缘信息重要
"bbox_expansion": 1.5

// 对象较小且精确
"bbox_expansion": 1.0

// 多对象场景，避免重叠
"bbox_expansion": 0.8
```

---

#### mask_hint_threshold (蒙版提示阈值)

**当前值**: `0.6`

**取值范围**: `0.0` 到 `1.0`（浮点数）

**作用**: 控制输入蒙版转换为提示点的阈值
- 高阈值：只在蒙版最强的区域生成提示点
- 低阈值：在更多蒙版区域生成提示点

**调整建议**:
```json
// 蒙版质量高，使用高阈值
"mask_hint_threshold": 0.8

// 蒙版模糊或不完整，使用低阈值
"mask_hint_threshold": 0.4

// 平衡值
"mask_hint_threshold": 0.6
```

---

#### mask_hint_use_negative (使用负向蒙版)

**当前值**: `"False"`

**可选值**: `"True"` / `"False"`

**作用**: 是否使用蒙版的反向区域作为负样本提示

**调整建议**:
```json
// 背景复杂，需要明确排除区域
"mask_hint_use_negative": "True"

// 简单背景，不需要
"mask_hint_use_negative": "False"
```

---

## 蒙版转 SEGS 参数

### 节点 15: MaskToSEGS

#### combined (合并分割)

**当前值**: `false`

**作用**: 是否将所有检测到的区域合并为一个 SEGS

**调整建议**:
```json
// 单对象抠图
"combined": false

// 多对象同时处理
"combined": true
```

---

#### crop_factor (裁剪因子)

**当前值**: `2`

**取值范围**: `1.0` 到 `10.0`（浮点数）

**作用**: 控制每个分割区域的裁剪边界
- 越大：包含更多周围上下文
- 越小：仅包含对象本身

**调整建议**:
```json
// 对象边缘需要更多上下文
"crop_factor": 3.0

// 精确裁剪，减少计算
"crop_factor": 1.5

// 默认值
"crop_factor": 2.0
```

---

#### drop_size (丢弃大小)

**当前值**: `10`

**取值范围**: `0` 到 `10000`（整数，像素）

**作用**: 过滤掉小于指定像素数的分割区域

**调整建议**:
```json
// 图像中有很多小噪点
"drop_size": 50

// 需要保留小细节
"drop_size": 5

// 标准过滤
"drop_size": 10
```

---

#### bbox_fill (填充边界框)

**当前值**: `false`

**作用**: 是否用边界框填充整个区域

**调整建议**:
```json
// 需要矩形蒙版
"bbox_fill": true

// 需要精确轮廓
"bbox_fill": false
```

---

#### contour_fill (轮廓填充)

**当前值**: `false`

**作用**: 是否填充轮廓内部的所有孔洞

**调整建议**:
```json
// 对象内部有孔洞需要填充（如甜甜圈）
"contour_fill": true

// 保留内部孔洞
"contour_fill": false
```

---

## 形态学处理参数

### 节点 43: Morphology

#### operation (操作类型)

**当前值**: `"close"`

**可选值**:
- `"erode"`: 腐蚀（收缩）
- `"dilate"`: 膨胀（扩张）
- `"open"`: 开运算（先腐蚀后膨胀，去除小突起）
- `"close"`: 闭运算（先膨胀后腐蚀，填充小孔）

**调整建议**:
```json
// 蒙版有小孔需要填充
"operation": "close"

// 蒙版有毛刺需要去除
"operation": "open"

// 需要整体缩小蒙版
"operation": "erode"

// 需要整体扩大蒙版
"operation": "dilate"
```

**视觉效果**:
```
原始蒙版:  ●  ●  ●
          ● ○ ●
          ●  ●  ●

close:    ●  ●  ●
          ●  ●  ●  (小孔被填充)
          ●  ●  ●

open:     ●  ●  ●
          ●    ●  (小突起被去除)
          ●  ●  ●
```

---

#### kernel_size (核大小)

**当前值**: `6`

**取值范围**: `1` 到 `99`（奇数）

**作用**: 形态学操作的结构元素大小
- 越大：效果越明显，影响范围越大
- 越小：效果越细微

**调整建议**:
```json
// 需要填充大孔或去除大毛刺
"kernel_size": 10

// 细微调整
"kernel_size": 3

// 标准值
"kernel_size": 6
```

---

## 蒙版扩展与模糊参数

### 节点 23: GrowMaskWithBlur

#### expand (扩展量)

**当前值**: `-3`

**取值范围**: `-100` 到 `100`（整数，像素）

**作用**: 蒙版扩展或收缩的像素数
- `正值`: 扩展蒙版（向外生长）
- `负值`: 收缩蒙版（向内收缩）
- `0`: 不改变大小

**⚠️ 这是最重要的参数之一！**

**调整建议**:
```json
// 抠图结果有白边，增加收缩
"expand": -5

// 抠图丢失边缘细节，减少收缩
"expand": -1

// 需要扩大选区
"expand": 3

// 当前值：收缩 3 像素
"expand": -3
```

**视觉示意**:
```
原始蒙版:      expand: -3       expand: 3
   ████            ██              ██████
   ████            ██              ██████
   ████            ██              ██████
```

---

#### blur_radius (模糊半径)

**当前值**: `1`

**取值范围**: `0.0` 到 `100.0`（浮点数）

**作用**: 蒙版边缘的模糊程度
- `0`: 完全锐利的边缘
- 越大：边缘越柔和

**调整建议**:
```json
// 需要非常柔和的过渡（人像抠图）
"blur_radius": 3.0

// 需要清晰边缘（产品图）
"blur_radius": 0.5

// 轻微羽化
"blur_radius": 1.0
```

---

#### tapered_corners (圆滑角落)

**当前值**: `true`

**作用**: 是否圆滑蒙版的角落

**调整建议**:
```json
// 自然对象（人物、动物）
"tapered_corners": true

// 几何对象（建筑、产品）
"tapered_corners": false
```

---

#### lerp_alpha (线性插值系数)

**当前值**: `1`

**取值范围**: `0.0` 到 `1.0`（浮点数）

**作用**: 控制扩展过程中边缘混合程度
- `1.0`: 完全使用新边缘
- `0.0`: 完全保留原边缘
- `0.5`: 新旧边缘各 50%

**调整建议**:
```json
// 完全使用新计算的边缘
"lerp_alpha": 1.0

// 保留部分原始边缘特征
"lerp_alpha": 0.7

// 更多保留原始特征
"lerp_alpha": 0.5
```

---

#### decay_factor (衰减因子)

**当前值**: `1`

**取值范围**: `0.0` 到 `1.0`（浮点数）

**作用**: 控制扩展的衰减速度
- `1.0`: 均匀扩展
- `<1.0`: 逐渐衰减的扩展

**调整建议**:
```json
// 均匀扩展
"decay_factor": 1.0

// 渐变式扩展
"decay_factor": 0.8
```

---

#### fill_holes (填充孔洞)

**当前值**: `false`

**作用**: 是否填充蒙版内部的孔洞

**调整建议**:
```json
// 需要填充内部孔洞
"fill_holes": true

// 保留孔洞（如眼镜框）
"fill_holes": false
```

---

## 实战调参案例

### 案例 1: 人像抠图 - 柔和边缘

**需求**: 抠出人像，边缘自然柔和，无白边

**参数设置**:
```json
{
  "10": {
    "inputs": {
      "mask_hint_threshold": 0.7,    // 提高精度
      "bbox_expansion": 1.2           // 稍微扩大范围
    }
  },
  "23": {
    "inputs": {
      "expand": -4,                   // 收缩 4 像素避免白边
      "blur_radius": 2.5,             // 较大模糊创建柔和过渡
      "tapered_corners": true         // 圆滑角落
    }
  }
}
```

---

### 案例 2: 产品图抠图 - 锐利边缘

**需求**: 抠出产品，边缘清晰锐利

**参数设置**:
```json
{
  "43": {
    "inputs": {
      "operation": "close",
      "kernel_size": 10                // 增大核以填充小缺陷
    }
  },
  "23": {
    "inputs": {
      "expand": -1,                    // 最小收缩
      "blur_radius": 0.3,              // 最小模糊保持锐利
      "tapered_corners": false         // 保持尖锐角落
    }
  }
}
```

---

### 案例 3: 复杂背景抠图

**需求**: 背景复杂，需要精确分割

**参数设置**:
```json
{
  "10": {
    "inputs": {
      "detection_hint": "center-3",    // 使用更多提示点
      "mask_hint_threshold": 0.8,      // 高阈值只用高质量区域
      "mask_hint_use_negative": "True" // 启用负样本
    }
  },
  "15": {
    "inputs": {
      "drop_size": 30                  // 过滤小噪点
    }
  },
  "43": {
    "inputs": {
      "operation": "close",
      "kernel_size": 8                 // 填充小孔
    }
  }
}
```

---

### 案例 4: 批量快速处理

**需求**: 快速处理，牺牲少量质量换取速度

**参数设置**:
```json
{
  "10": {
    "inputs": {
      "detection_hint": "center-1",    // 最简单的提示
      "threshold": 0.8                 // 降低阈值加快速度
    }
  },
  "43": {
    "inputs": {
      "kernel_size": 4                 // 减小核大小
    }
  },
  "23": {
    "inputs": {
      "expand": -3,
      "blur_radius": 1                 // 标准设置
    }
  }
}
```

---

### 案例 5: 毛发边缘处理

**需求**: 处理毛发等细节丰富的边缘

**参数设置**:
```json
{
  "10": {
    "inputs": {
      "bbox_expansion": 1.5,           // 扩大范围捕获细节
      "mask_hint_threshold": 0.5       // 降低阈值捕获细节
    }
  },
  "15": {
    "inputs": {
      "drop_size": 3                   // 保留小细节
    }
  },
  "23": {
    "inputs": {
      "expand": -1,                    // 最小收缩保留细节
      "blur_radius": 1.5,              // 适中模糊
      "lerp_alpha": 0.8                // 保留部分原始边缘
    }
  }
}
```

---

## 调参流程建议

### 第一步: 基础分割质量
1. 检查 SAM 分割结果（节点 10 输出）
2. 调整 `mask_hint_threshold` 和 `detection_hint`
3. 使用 `mask_hint_use_negative` 排除干扰

### 第二步: 蒙版清理
1. 检查是否有小孔需要填充
2. 调整形态学 `operation` 和 `kernel_size`

### 第三步: 边缘优化
1. 检查是否有白边/黑边
2. 调整 `expand` 值（通常 -2 到 -5）
3. 根据需求调整 `blur_radius`

### 第四步: 细节微调
1. 调整 `tapered_corners` 根据对象类型
2. 调整 `lerp_alpha` 平衡新旧边缘
3. 如需填充孔洞，启用 `fill_holes`

---

## 常见问题解决方案

| 问题 | 参数调整 | 说明 |
|-----|---------|-----|
| 结果有白边 | `expand: -5` 或更大负值 | 增加收缩量 |
| 边缘不够柔和 | `blur_radius: 2-3` | 增加模糊 |
| 丢失细节 | `expand: -1`, `drop_size: 3` | 减少收缩，保留小区域 |
| 分割不准确 | `mask_hint_threshold: 0.7-0.8` | 提高阈值 |
| 蒙版有小孔 | `operation: "close"`, `kernel_size: 8-10` | 使用闭运算 |
| 边缘有毛刺 | `operation: "open"`, `kernel_size: 6` | 使用开运算 |
| 处理速度慢 | `detection_hint: "center-1"`, 减小 `kernel_size` | 使用简单参数 |

---

## 总结

参数调整的黄金法则：
1. **先粗后细**: 先调整 SAM 分割质量，再调整边缘
2. **逐步调整**: 每次只改变 1-2 个参数
3. **测试验证**: 每次调整后测试效果
4. **记录参数**: 保存有效的参数组合
5. **分类使用**: 针对不同类型的图像使用不同预设
